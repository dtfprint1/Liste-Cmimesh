<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="utf-8" />
  <title>Liste cmimesh & kalkulator â€“ dtfprint</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ===================== SAME STYLING AS APPROVED VERSION (kepritet nga versioni yt i fundit) ===================== */
    :root {
      --bg-page: #0f172a;
      --bg-section: #020617;
      --card-bg: #020617;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.12);
      --accent-strong: #0ea5e9;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-subtle: #1f2937;
      --radius-xl: 1.5rem;
      --radius-lg: 1rem;
      --radius-full: 999px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.75);
      --shadow-card: 0 16px 35px rgba(15, 23, 42, 0.9);
      --transition-fast: 0.18s ease-out;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 52%, #000 100%);
      color:var(--text-main); line-height:1.5; padding:32px 16px 48px;
    }
    .page-wrapper{max-width:1120px;margin:0 auto}

    /* HERO (identik me atÃ« qÃ« ke aprovuar) */
    .hero{
      display:grid; grid-template-columns:minmax(0,1.5fr) minmax(0,1.2fr); gap:32px;
      padding:28px; border-radius:24px; border:1px solid rgba(148,163,184,0.25);
      background:
        radial-gradient(circle at top left, rgba(56,189,248,0.18), transparent 60%),
        radial-gradient(circle at bottom right, rgba(56,189,248,0.05), transparent 55%),
        rgba(15,23,42,0.9);
      box-shadow:var(--shadow-soft); position:relative; overflow:hidden;
    }
    .hero::before{
      content:""; position:absolute; inset:0;
      background: radial-gradient(circle at top right, rgba(15,118,110,0.15), transparent 55%);
      opacity:0.5; pointer-events:none;
    }
    .hero-left{position:relative; z-index:2}
    .badge{display:inline-flex; align-items:center; gap:8px; padding:4px 12px; border-radius:999px; background:rgba(15,23,42,0.78); border:1px solid rgba(148,163,184,0.5); margin-bottom:14px; backdrop-filter:blur(12px)}
    .badge-dot{width:22px;height:22px;border-radius:999px;background:radial-gradient(circle at 30% 30%, #f9fafb, #22c55e 55%, #15803d 100%); box-shadow:0 0 18px rgba(34,197,94,0.9); border:2px solid rgba(15,23,42,0.85)}
    .hero-title{font-size:clamp(26px,4vw,34px);font-weight:700; letter-spacing:-0.04em;margin-bottom:10px}
    .hero-title span{background:linear-gradient(120deg,#38bdf8,#a855f7,#22c55e); -webkit-background-clip:text;color:transparent}
    .hero-subtitle{font-size:14px;color:var(--text-muted);max-width:500px;margin-bottom:20px}
    .hero-tags{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:22px}
    .tag{font-size:11px;padding:5px 10px;border-radius:999px;background:rgba(15,23,42,0.85);border:1px solid rgba(148,163,184,0.35);color:var(--text-muted)}
    .hero-actions{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:9px 16px;border-radius:999px;font-size:13px;font-weight:500;border:1px solid transparent;cursor:pointer;text-decoration:none;transition:transform var(--transition-fast),box-shadow var(--transition-fast),background var(--transition-fast),border-color var(--transition-fast),color var(--transition-fast);white-space:nowrap}
    .btn-primary{background:linear-gradient(135deg,#38bdf8,#0ea5e9);color:#020617;box-shadow:0 13px 30px rgba(8,47,73,0.9)}
    .btn-outline{background:rgba(15,23,42,0.85);color:var(--text-main);border-color:rgba(148,163,184,0.5)}
    .btn-xs{padding:6px 10px;font-size:11px;border-radius:999px}
    .hero-right{position:relative; z-index:1; display:flex; align-items:center; justify-content:center}
    .hero-pricing-card{width:100%;max-width:360px;background:rgba(2,6,23,0.95);border-radius:var(--radius-xl);padding:16px 16px 14px;border:1px solid rgba(148,163,184,0.6);box-shadow:var(--shadow-card);backdrop-filter:blur(14px)}
    .hpc-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .hpc-title{font-size:13px;text-transform:uppercase;letter-spacing:0.16em;color:var(--text-muted)}
    .hpc-pill{font-size:11px;padding:4px 10px;border-radius:999px;background:rgba(22,163,74,0.12);color:#4ade80;border:1px solid rgba(34,197,94,0.45)}
    .hpc-toggle{display:inline-flex;padding:3px;border-radius:999px;background:rgba(15,23,42,0.8);border:1px solid rgba(148,163,184,0.5);margin-bottom:10px}
    .hpc-toggle span{font-size:11px;padding:4px 10px;border-radius:999px;color:var(--text-muted);cursor:pointer;transition:background var(--transition-fast),color var(--transition-fast)}
    .hpc-toggle span.active{background:var(--accent-soft);color:var(--accent-strong)}
    .hpc-main{border-radius:16px;padding:10px 12px 10px;border:1px solid rgba(148,163,184,0.35);margin-bottom:10px;background:radial-gradient(circle at top, rgba(56,189,248,0.15), transparent 60%)}
    .hpc-row{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:4px;font-size:12px;color:var(--text-muted)}
    .hpc-row strong{color:var(--text-main);font-size:13px}
    .hpc-footer{display:flex;justify-content:space-between;align-items:center;gap:10px}
    /* SECTION */
    .section{margin-top:32px;padding:22px 20px 20px;border-radius:22px;background:rgba(15,23,42,0.92);border:1px solid rgba(30,64,175,0.5);box-shadow:var(--shadow-soft)}
    .section-title{font-size:16px;font-weight:600;letter-spacing:-0.02em}
    .section-subtitle{font-size:12px;color:var(--text-muted);max-width:360px}
    /* CALC */
    .prices-card{border-radius:18px;padding:14px 14px 12px;box-shadow:0 14px 34px rgba(15,23,42,0.9);background:radial-gradient(circle at top, rgba(56,189,248,0.12), transparent 60%), #020617;border:1px solid rgba(55,65,81,0.85)}
    .calc-card{border-radius:18px;padding:14px 14px 12px;box-shadow:0 14px 34px rgba(15,23,42,0.9);background:radial-gradient(circle at top right, rgba(129,140,248,0.15), transparent 55%), #020617;border:1px solid rgba(79,70,229,0.85)}
    .calc-form{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;margin-bottom:10px}
    .calc-field{display:flex;flex-direction:column;gap:3px;font-size:11px}
    .calc-label{color:var(--text-muted)}
    .calc-input,.calc-select{padding:6px 8px;border-radius:999px;border:1px solid rgba(55,65,81,0.9);background:rgba(15,23,42,0.95);color:var(--text-main);font-size:11px;outline:none}
    .calc-input:focus,.calc-select:focus{border-color:var(--accent);box-shadow:0 0 0 1px rgba(56,189,248,0.4)}
    .calc-actions{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:8px;flex-wrap:wrap}
    .calc-result{font-size:12px;font-weight:500;color:var(--accent-strong);font-variant-numeric:tabular-nums}
    .calc-note{font-size:10px;color:var(--text-muted)}
    .calc-pill{font-size:10px;padding:4px 8px;border-radius:999px;background:rgba(15,23,42,0.9);border:1px dashed rgba(148,163,184,0.5);color:var(--text-muted)}
    #cartButtons{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;margin-top:6px}
    #packageBreakdownContainer{margin-top:10px}
    .btn-mini-danger{border-radius:999px;border:1px solid rgba(248,113,113,0.8);background:rgba(127,29,29,0.9);color:#fee2e2;font-size:10px;padding:2px 8px;cursor:pointer}
    /* CART DRAWER (added, minimal visual changes) */
    .cart-floating{
      position:fixed; right:20px; bottom:20px; z-index:9999; background:linear-gradient(180deg,#38bdf8,#8b5cf6); color:#031426; width:64px;height:64px;border-radius:999px;display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:0 12px 30px rgba(2,6,23,0.6); cursor:pointer; border:0;
    }
    .cart-badge{position:absolute; top:-8px; right:-8px; background:#ff4d4d; color:white; padding:4px 8px; border-radius:999px; font-size:12px}
    .cart-drawer{
      position:fixed; right:0; top:0; height:100vh; width:420px; transform:translateX(110%); transition:transform .25s cubic-bezier(.2,.9,.3,1); z-index:10000; box-shadow:-30px 0 60px rgba(2,6,23,0.6); padding:20px; background:linear-gradient(180deg, rgba(2,6,23,0.96), rgba(3,6,18,0.98)); border-left:1px solid rgba(255,255,255,0.02);
    }
    .cart-drawer.open{transform:translateX(0)}
    .cart-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);margin-bottom:10px}
    .mini-btn{padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text-muted);cursor:pointer}
    .drawer-footer{position:absolute; left:0; bottom:0; width:100%; padding:18px; background:linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.03)); border-top:1px solid rgba(255,255,255,0.02)}
    .drawer-total{font-weight:800;font-size:18px;color:var(--accent); margin-bottom:8px}
    /* responsive */
    @media (max-width:960px){
      .hero{grid-template-columns:1fr}
      .cart-drawer{width:100%}
    }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <!-- HERO (original content unchanged) -->
    <section class="hero">
      <div class="hero-left">
        <div class="badge"><div class="badge-dot"></div><span class="badge-text">Segmentim profesional i klienteve</span></div>
        <h1 class="hero-title">Produkte tÃ« personalizuara pÃ«r <span>klientÃ« normal & rishitÃ«s</span></h1>
        <p class="hero-subtitle">Ndarje e qartÃ« midis porosive personale dhe atyre me shumicÃ«, me Ã§mim qÃ« ndryshon sipas sasisÃ«, madhÃ«sisÃ« dhe numrit tÃ« stampave pÃ«r Ã§do lloj produkti.</p>
        <div class="hero-tags">
          <div class="tag"><strong>KlientÃ« normal:</strong> porosi tÃ« vogla & dhurata</div>
          <div class="tag"><strong>RishitÃ«s:</strong> Ã§mime me shumicÃ« & B2B</div>
        </div>
        <div class="hero-actions">
          <a href="#kalkulatori" class="btn btn-primary" onclick="scrollToCalculator(); return false;">Hap kalkulatorin</a>
          <a href="#cmimet" class="btn btn-outline" onclick="scrollToPrices(); return false;">Shiko listÃ«n e cmimeve</a>
        </div>
      </div>

      <div class="hero-right">
        <div class="hero-pricing-card">
          <div class="hpc-header">
            <div><p class="hpc-title">Segmenti aktiv</p></div>
            <span class="hpc-pill">dtfprint â€“ cmime orientuese</span>
          </div>
          <div class="hpc-toggle">
            <span id="segmentNormalBtn" class="active" onclick="setSegment('normal');">Klient normal</span>
            <span id="segmentResellerBtn" onclick="setSegment('reseller');">RishitÃ«s</span>
          </div>
          <div class="hpc-main">
            <div class="hpc-row"><span class="hpc-label">Sasia</span><strong>1 â€“ 50+ copÃ«</strong></div>
            <div class="hpc-row"><span class="hpc-label">ShtesÃ« pÃ«r stampÃ« shtesÃ«</span><strong>200 LekÃ« / copÃ«</strong></div>
            <div class="hpc-row"><span class="hpc-label">Zbritje automatike</span><strong>sipas sasisÃ« & segmentit</strong></div>
          </div>
          <div class="hpc-footer">
            <p class="hpc-footer-note" id="segmentInfo">Segment: Klient normal â€“ cmim standard pÃ«r 1â€“5 copÃ«, zbritje graduale pÃ«r sasira mÃ« tÃ« mÃ«dha.</p>
            <button class="btn btn-primary btn-xs" onclick="scrollToCalculator();">Shko te kalkulatori</button>
          </div>
        </div>
      </div>
    </section>

    <!-- KALKULATORI (original controls preserved) -->
    <section class="section" id="kalkulatori">
      <div class="section-header">
        <div>
          <h2 class="section-title">Kalkulator oferte (live)</h2>
          <p class="section-subtitle">Zgjidh produktin, vendos sasinÃ« dhe numrin e stampave. MÃ« pas shtoje nÃ« shportÃ«. Mund tÃ« kesh disa produkte dhe nÃ« fund llogaritet totali.</p>
        </div>
        <div class="pill-soft"><span class="pill-dot"></span>Shtesa pÃ«r stampÃ« shtesÃ«: 200 LekÃ« / stampÃ« (fiks, e vendosur nga ti).</div>
      </div>

      <article class="calc-card">
        <h3>Kalkulator i shpejtÃ« â€“ bazuar te cmimet dtfprint.al</h3>
        <p>Perllogarit Ã§mime pÃ«r njÃ« produkt tÃ« vetÃ«m ose pÃ«r oferta me disa produkte. Segmentin (Klient normal / RishitÃ«s) e zgjedh lart nÃ« seksionin â€œSegmenti aktivâ€.</p>

        <div class="calc-form">
          <div class="calc-field">
            <label class="calc-label" for="productSelect">Produkti</label>
            <select id="productSelect" class="calc-select"></select>
          </div>

          <div class="calc-field">
            <label class="calc-label" for="quantityInput">Sasia (copÃ«)</label>
            <input id="quantityInput" type="number" min="1" value="1" class="calc-input" />
          </div>

          <div class="calc-field">
            <label class="calc-label" for="printsInput">Nr. stampave pÃ«r copÃ«</label>
            <input id="printsInput" type="number" min="1" value="1" class="calc-input" />
          </div>

          <div class="calc-field">
            <label class="calc-label">Shtesa pÃ«r stampÃ« shtesÃ«</label>
            <input type="text" class="calc-input" value="200 LekÃ« / stampÃ« shtesÃ«" disabled />
          </div>
        </div>

        <div class="calc-actions">
          <div>
            <div class="calc-result" id="unitPriceDisplay">Ã‡mimi pÃ«r copÃ«: â€“</div>
            <div class="calc-result" id="totalPriceDisplay">Totali: â€“</div>
          </div>

          <div style="flex:1; min-width:260px;">
            <div class="calc-pill" id="breakdownDisplay">Formula: baza e produktit + stampat shtesÃ« + zbritja nga sasia/segmenti.</div>
            <div id="cartButtons">
              <button class="btn btn-outline btn-xs" onclick="addCurrentToCart();">Shto kÃ«tÃ« produkt nÃ« shportÃ«</button>
              <button class="btn btn-outline btn-xs" onclick="clearCart();">Pastro shportÃ«n</button>
            </div>
          </div>
        </div>

        <p class="calc-note">* Zbritjet nga sasia aplikohen automatikisht: 1â€“5 copÃ« (cmim i plotÃ«), 6â€“10 (âˆ’5%), 11â€“20 (âˆ’10%), 21â€“50 (âˆ’15%), 51+ (âˆ’20%). Segmenti RishitÃ«s merr edhe âˆ’10% ekstra mbi total.</p>

        <div id="packageBreakdownContainer" style="display:none;">
          <div class="calc-pill" id="packageTitle">Oferta aktuale (multi-produkte):</div>
          <div class="prices-table-wrapper" style="max-height:220px;">
            <table class="prices-table">
              <thead>
                <tr><th>Produkti</th><th>Sasia</th><th>Stampat</th><th>Ã‡mimi / copÃ«</th><th>Totali</th><th></th></tr>
              </thead>
              <tbody id="packageBreakdownBody"></tbody>
            </table>
          </div>
        </div>
      </article>
    </section>

    <!-- PAKETAT + LISTA CMIMESH (original content left unchanged) -->
    <section class="section" id="paketat">
      <div class="section-header">
        <div><h2 class="section-title">Paketa tÃ« gatshme pÃ«r shitje</h2><p class="section-subtitle">Paketa tÃ« pÃ«rgatitura qÃ« mbushin shportÃ«n me njÃ« klik.</p></div>
      </div>

      <div class="packages-grid">
        <article class="package-card">
          <p class="package-badge">PÃ«r klientÃ« normal</p>
          <h3 class="package-name">Starter Pack Personal</h3>
          <p class="package-items">1 HOODIE 300 GSM Â· 1 PREMIUM 180 Â· 1 NATURELLA 120</p>
          <div class="package-footer">
            <p class="package-note">Llogarit automatikisht gjithÃ« paketÃ«n me njÃ« klik.</p>
            <button class="btn btn-primary btn-xs" onclick="setSegment('normal'); applyPreset('starter-personal');">Shto nÃ« shportÃ«</button>
          </div>
        </article>

        <article class="package-card">
          <p class="package-badge">PÃ«r rishitÃ«s & brand-e</p>
          <h3 class="package-name">Brand Starter Pack</h3>
          <p class="package-items">5 HOODIE 300 GSM + 10 PREMIUM 180 + 20 CAMPUS MAT</p>
          <div class="package-footer">
            <p class="package-note">Llogaritet total-i i gjithÃ« paketÃ«s pÃ«r rishitÃ«s, me zbritje ekstra.</p>
            <button class="btn btn-outline btn-xs" onclick="setSegment('reseller'); applyPreset('brand-pack');">KÃ«rko ofertÃ«</button>
          </div>
        </article>
      </div>
    </section>

    <section class="section prices-section" id="cmimet">
      <div class="section-header">
        <div><h2 class="section-title">Lista bazÃ« e cmimeve (1 copÃ«)</h2><p class="section-subtitle">Cmime orientuese pÃ«r 1 copÃ«, bazuar nÃ« listÃ«n e cmimeve dtfprint.al.</p></div>
      </div>
      <article class="prices-card">
        <h3>Produktet kryesore</h3>
        <div class="prices-table-wrapper">
          <table class="prices-table"><thead><tr><th>Produkti</th><th>Kategoria</th><th>Ã‡mimi / copÃ«</th></tr></thead><tbody id="pricesTableBody"></tbody></table>
        </div>
      </article>
    </section>

  </div>

  <!-- FLOATING CART BUTTON -->
  <button id="cartFloatingBtn" class="cart-floating" title="Shporta">
    ğŸ›’
    <span id="floatingBadge" class="cart-badge" style="display:none">0</span>
  </button>

  <!-- CART DRAWER -->
  <aside id="cartDrawer" class="cart-drawer" aria-hidden="true">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div><small class="small-muted">Shporta</small><h3>Oferta & Shporta</h3></div>
      <div><button class="mini-btn" onclick="toggleCart()">Mbyll</button></div>
    </div>

    <div id="cartList" style="max-height:65vh; overflow:auto; margin-bottom:12px;">
      <!-- injected items -->
    </div>

    <div class="drawer-footer">
      <div class="drawer-total" id="drawerTotal">Totali: â€”</div>
      <div style="display:flex;gap:8px">
        <button class="mini-btn" onclick="clearCart()">Pastro</button>
        <button class="btn btn-primary" onclick="checkout()">KÃ«rko ofertÃ« / Porosit</button>
      </div>
    </div>
  </aside>

  <!-- ================== SCRIPT (I SAME LOGIC BUT ADDED CART DRAWER HANDLERS) ================== -->
  <script>
    // Konfigurim (saktÃ«sisht si nÃ« versionin tÃ«nd tÃ« mÃ«parshÃ«m)
    const EXTRA_PRINT_PRICE = 200; // LekÃ« / stampÃ« shtesÃ« pÃ«r copÃ«
    const quantityTiers = [
      { max: 5, label: "1â€“5 copÃ«", multiplier: 1.0 },
      { max: 10, label: "6â€“10 copÃ«", multiplier: 0.95 },
      { max: 20, label: "11â€“20 copÃ«", multiplier: 0.90 },
      { max: 50, label: "21â€“50 copÃ«", multiplier: 0.85 },
      { max: Infinity, label: "51+ copÃ«", multiplier: 0.80 }
    ];
    const resellerMultiplier = 0.90; // âˆ’10% pÃ«r rishitÃ«s

    const products = [
      { id: "premium180", name: "PREMIUM 180 â€“ Bluze 180 GSM", category: "Tekstil", price: 700 },
      { id: "azzuroPolo", name: "AZZURO POLO â€“ Bluze polo 180 GSM", category: "Tekstil", price: 900 },
      { id: "gator", name: "GATOR â€“ Bluze polo 180 GSM", category: "Tekstil", price: 1000 },
      { id: "spring", name: "SPRING â€“ Sweatshirt 300 GSM", category: "Tekstil", price: 1700 },
      { id: "hoodie300", name: "HOODIE â€“ Hoodie 300 GSM", category: "Tekstil", price: 1900 },
      { id: "campusMat", name: "CAMPUS MAT â€“ Mouse Pad", category: "Promo", price: 450 },
      { id: "lager", name: "LAGER â€“ Thermal Bag", category: "Ã‡anta", price: 350 },
      { id: "naturella", name: "NATURELLA 120 â€“ Totebag 120 gr", category: "Ã‡anta", price: 250 },
      { id: "documento", name: "DOCUMENTO â€“ Ã‡antÃ« dokumentash", category: "Ã‡anta", price: 300 },
      { id: "camposPlus", name: "CAMPOS PLUS â€“ Ã‡adÃ«r", category: "Ã‡adra", price: 750 },
      { id: "nimbus", name: "NIMBUS â€“ Ã‡adÃ«r", category: "Ã‡adra", price: 800 },
      { id: "rossi", name: "ROSSI â€“ Ã‡adÃ«r", category: "Ã‡adra", price: 850 }
    ];

    const packagePresets = {
      "starter-personal": {
        name: "Starter Pack Personal",
        items: [
          { productId: "hoodie300", qty: 1, prints: 2 },
          { productId: "premium180", qty: 1, prints: 1 },
          { productId: "naturella", qty: 1, prints: 1 }
        ]
      },
      "brand-pack": {
        name: "Brand Starter Pack",
        items: [
          { productId: "hoodie300", qty: 5, prints: 2 },
          { productId: "premium180", qty: 10, prints: 1 },
          { productId: "campusMat", qty: 20, prints: 1 }
        ]
      }
    };

    let currentSegment = "normal";    // "normal" ose "reseller"
    let cartItems = [];               // lista e produkteve nÃ« ofertÃ« (per shporte)
    let cartLabel = "Oferta aktuale (multi-produkte)";

    // Helpers
    function formatALL(value) {
      if (isNaN(value)) return "â€“";
      try {
        return value.toLocaleString("sq-AL", { style: "currency", currency: "ALL", maximumFractionDigits: 0 });
      } catch (e) {
        return value.toLocaleString("sq-AL") + " LekÃ«";
      }
    }
    function getQuantityTier(qty) { for (const tier of quantityTiers) if (qty <= tier.max) return tier; return quantityTiers[quantityTiers.length - 1]; }
    function findProduct(id) { return products.find(p => p.id === id) || null; }

    function computeLine(productId, qty, prints) {
      const p = findProduct(productId);
      if (!p) return null;
      const safeQty = Math.max(qty || 1, 1);
      const safePrints = Math.max(prints || 1, 1);
      const extraPrints = Math.max(safePrints - 1, 0);
      const extraPerUnit = extraPrints * EXTRA_PRINT_PRICE;
      const baseUnitPrice = p.price;
      const unitWithPrints = baseUnitPrice + extraPerUnit;
      const tier = getQuantityTier(safeQty);
      const segmentMultiplier = currentSegment === "reseller" ? resellerMultiplier : 1;
      const unitAfterQty = unitWithPrints * tier.multiplier * segmentMultiplier;
      const finalUnit = Math.round(unitAfterQty);
      const total = finalUnit * safeQty;
      return { product: p, qty: safeQty, prints: safePrints, baseUnitPrice, extraPrints, extraPerUnit, unitWithPrints, tier, finalUnit, total };
    }

    // populate lists
    function populatePricesTable() {
      const tbody = document.getElementById("pricesTableBody"); if (!tbody) return; tbody.innerHTML = "";
      products.forEach((p) => {
        const tr = document.createElement("tr");
        const nameTd = document.createElement("td"); nameTd.className = "name-cell"; nameTd.textContent = p.name; tr.appendChild(nameTd);
        const catTd = document.createElement("td"); catTd.className = "category-cell"; catTd.textContent = p.category; tr.appendChild(catTd);
        const priceTd = document.createElement("td"); priceTd.className = "price-cell"; priceTd.textContent = formatALL(p.price); tr.appendChild(priceTd);
        tbody.appendChild(tr);
      });
    }
    function populateProductSelect() {
      const select = document.getElementById("productSelect"); if (!select) return; select.innerHTML = "";
      products.forEach((p) => { const opt = document.createElement("option"); opt.value = p.id; opt.textContent = `${p.name} â€“ ${formatALL(p.price)}`; select.appendChild(opt); });
    }

    // Single calc
    function calculateSingleTotal() {
      const select = document.getElementById("productSelect");
      const quantityInput = document.getElementById("quantityInput");
      const printsInput = document.getElementById("printsInput");
      const unitDisplay = document.getElementById("unitPriceDisplay");
      const totalDisplay = document.getElementById("totalPriceDisplay");
      const breakdownDisplay = document.getElementById("breakdownDisplay");
      const container = document.getElementById("packageBreakdownContainer");
      if (container && cartItems.length === 0) container.style.display = "none";
      if (!select || !quantityInput || !printsInput || !unitDisplay || !totalDisplay || !breakdownDisplay) return;
      const line = computeLine(select.value, parseInt(quantityInput.value, 10), parseInt(printsInput.value, 10));
      if (!line) { unitDisplay.textContent = "Ã‡mimi pÃ«r copÃ«: â€“"; totalDisplay.textContent = "Totali: â€“"; breakdownDisplay.textContent = "Zgjidh produktin pÃ«r tÃ« llogaritur."; return; }
      unitDisplay.textContent = "Ã‡mimi pÃ«r copÃ«: " + formatALL(line.finalUnit);
      totalDisplay.textContent = "Totali pÃ«r " + line.qty + " copÃ«: " + formatALL(line.total);
      const qtyDiscountPercent = Math.round((1 - line.tier.multiplier) * 100);
      const resellerDiscountPercent = currentSegment === "reseller" ? Math.round((1 - resellerMultiplier) * 100) : 0;
      const parts = [
        `Baza: ${formatALL(line.baseUnitPrice)}`,
        line.extraPrints > 0 ? `+ ${line.extraPrints} stamp. shtesÃ« Ã— ${formatALL(EXTRA_PRINT_PRICE)}` : "+ pa stampÃ« shtesÃ«",
        `Â· Zbritje sasia: ${line.tier.label}${qtyDiscountPercent > 0 ? ` (${qtyDiscountPercent}% -)` : ""}`
      ];
      if (resellerDiscountPercent > 0) parts.push(`Â· RishitÃ«s: âˆ’${resellerDiscountPercent}% ekstra`);
      breakdownDisplay.textContent = parts.join("  ");
    }

    // CART (drawer) logic (added)
    function updateFloatingBadge() {
      const badge = document.getElementById("floatingBadge");
      const count = cartItems.reduce((s, it) => s + it.qty, 0);
      if (count > 0) { badge.style.display = "inline-block"; badge.textContent = count; } else badge.style.display = "none";
    }

    function openCart() { const d = document.getElementById("cartDrawer"); d.classList.add("open"); d.setAttribute("aria-hidden","false"); }
    function closeCart() { const d = document.getElementById("cartDrawer"); d.classList.remove("open"); d.setAttribute("aria-hidden","true"); }
    function toggleCart() { const d = document.getElementById("cartDrawer"); d.classList.toggle("open"); d.setAttribute("aria-hidden", !d.classList.contains("open")); }

    function renderCartDrawer() {
      const list = document.getElementById("cartList"); list.innerHTML = "";
      if (cartItems.length === 0) {
        list.innerHTML = '<div class="small-muted" style="padding:12px">Shporta Ã«shtÃ« bosh. Shto produkte nga kalkulatori.</div>';
        document.getElementById("drawerTotal").textContent = 'Totali: â€”';
        updateFloatingBadge();
        // also hide packageBreakdown
        document.getElementById("packageBreakdownContainer").style.display = "none";
        return;
      }
      let grand = 0;
      cartItems.forEach((it, idx) => {
        const ln = computeLine(it.productId, it.qty, it.prints);
        if (!ln) return;
        grand += ln.total;
        const wrap = document.createElement('div'); wrap.className = 'cart-item';
        wrap.innerHTML = `<div style="flex:1"><div style="font-weight:700">${ln.product.name}</div><div class="small-muted" style="margin-top:6px">${formatALL(ln.finalUnit)} / copÃ« â€” Tot: ${formatALL(ln.total)}</div></div>
                          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
                            <div style="display:flex;gap:6px;align-items:center">
                              <button class="mini-btn" onclick="changeCartQty(${idx}, ${Math.max(1, it.qty - 1)})">âˆ’</button>
                              <div style="padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02)">${it.qty}</div>
                              <button class="mini-btn" onclick="changeCartQty(${idx}, ${it.qty + 1})">+</button>
                            </div>
                            <div><button class="mini-btn" onclick="removeCartItem(${idx})">Hiq</button></div>
                          </div>`;
        list.appendChild(wrap);
      });
      document.getElementById("drawerTotal").textContent = 'Totali: ' + formatALL(cartItems.reduce((s,it) => s + computeLine(it.productId,it.qty,it.prints).total,0));
      updateFloatingBadge();

      // also update the calculator's package breakdown table to mirror cart
      const packageBody = document.getElementById("packageBreakdownBody"); packageBody.innerHTML = "";
      cartItems.forEach((it, index) => {
        const line = computeLine(it.productId, it.qty, it.prints);
        if (!line) return;
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="name-cell">${line.product.name}</td>
                        <td>${line.qty}</td>
                        <td>${line.prints}</td>
                        <td class="price-cell">${formatALL(line.finalUnit)}</td>
                        <td class="price-cell">${formatALL(line.total)}</td>
                        <td><button class="btn-mini-danger" onclick="removeCartItem(${index})">Hiq</button></td>`;
        packageBody.appendChild(tr);
      });
      const trTotal = document.createElement("tr");
      trTotal.innerHTML = `<td colspan="4" style="text-align:right;font-weight:600">Totali i ofertÃ«s</td><td class="price-cell" style="font-weight:600">${formatALL(cartItems.reduce((s,it)=>s+computeLine(it.productId,it.qty,it.prints).total,0))}</td><td></td>`;
      packageBody.appendChild(trTotal);
      document.getElementById("packageBreakdownContainer").style.display = "block";
    }

    function addCurrentToCart() {
      const sel = document.getElementById("productSelect");
      const quantityInput = document.getElementById("quantityInput");
      const printsInput = document.getElementById("printsInput");
      const item = { productId: sel.value, qty: Math.max(parseInt(quantityInput.value, 10) || 1, 1), prints: Math.max(parseInt(printsInput.value, 10) || 1, 1) };
      // merge if same product+prints
      const existing = cartItems.findIndex(i => i.productId === item.productId && i.prints === item.prints);
      if (existing >= 0) cartItems[existing].qty += item.qty; else cartItems.push(item);
      renderCartDrawer();
      openCart();
    }

    function changeCartQty(index, newQty) { if (newQty < 1) return; cartItems[index].qty = newQty; renderCartDrawer(); }
    function removeCartItem(index) { cartItems.splice(index, 1); renderCartDrawer(); }
    function clearCart() { cartItems = []; renderCartDrawer(); }

    function applyPreset(presetId) {
      const preset = packagePresets[presetId];
      const productSelect = document.getElementById("productSelect");
      const quantityInput = document.getElementById("quantityInput");
      const printsInput = document.getElementById("printsInput");
      if (!preset) return;
      cartItems = preset.items.map(i => ({ ...i }));
      cartLabel = "Paketa e zgjedhur: " + preset.name;
      const first = preset.items[0];
      productSelect.value = first.productId; quantityInput.value = first.qty; printsInput.value = first.prints;
      renderCartDrawer();
      openCart();
    }

    // Segments (same as before)
    function setSegment(segment) {
      currentSegment = segment === "reseller" ? "reseller" : "normal";
      const normalBtn = document.getElementById("segmentNormalBtn");
      const resellerBtn = document.getElementById("segmentResellerBtn");
      const segmentInfo = document.getElementById("segmentInfo");
      if (normalBtn && resellerBtn) { normalBtn.classList.toggle("active", currentSegment === "normal"); resellerBtn.classList.toggle("active", currentSegment === "reseller"); }
      if (segmentInfo) {
        if (currentSegment === "normal") segmentInfo.textContent = "Segment: Klient normal â€“ cmim standard pÃ«r 1â€“5 copÃ«, zbritje graduale pÃ«r sasira mÃ« tÃ« mÃ«dha.";
        else segmentInfo.textContent = "Segment: RishitÃ«s â€“ zbritje ekstra âˆ’10% mbi cmimin me pakicÃ« + zbritjet nga sasia.";
      }
      if (cartItems.length > 0) renderCartDrawer(); else calculateSingleTotal();
    }

    // Checkout example
    function checkout(){
      if(cartItems.length===0){ alert('Shporta Ã«shtÃ« bosh. Shto produkte pÃ«r tÃ« kÃ«rkuar ofertÃ«.'); return; }
      let msg = 'PÃ«rmbledhje e ofertÃ«s:\\n\\n';
      cartItems.forEach(it => {
        const ln = computeLine(it.productId, it.qty, it.prints);
        msg += `${ln.product.name} â€” ${it.qty} copÃ« Ã— ${formatALL(ln.finalUnit)} = ${formatALL(ln.total)}\\n`;
      });
      const grand = cartItems.reduce((s,it) => s + computeLine(it.productId,it.qty,it.prints).total,0);
      msg += `\\nTotali: ${formatALL(grand)}\\n\\n(ky Ã«shtÃ« njÃ« shembull; dÃ«rgo te email/CRM).`;
      alert(msg);
    }

    // Init
    document.addEventListener("DOMContentLoaded", () => {
      populatePricesTable();
      populateProductSelect();
      setSegment("normal");
      calculateSingleTotal();
      renderCartDrawer();
      document.getElementById("productSelect").addEventListener("change", () => { if (cartItems.length === 0) calculateSingleTotal(); });
      document.getElementById("quantityInput").addEventListener("input", () => { if (cartItems.length === 0) calculateSingleTotal(); });
      document.getElementById("printsInput").addEventListener("input", () => { if (cartItems.length === 0) calculateSingleTotal(); });
      document.getElementById("cartFloatingBtn").addEventListener("click", toggleCart);
    });
  </script>
</body>
</html>
